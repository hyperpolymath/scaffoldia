= repo-batcher Operations Guide (Expanded)
:toc:
:toclevels: 3
:version: 0.9.0
:date: 2026-02-06

== Overview

repo-batcher now provides **6 formally verified operations** for managing 574+ repositories at scale. All operations are implemented in ATS2 with dependent type proofs and integrated with V for high-performance parallel execution.

== Core Operations

=== 1. license-update

**Purpose**: Replace license headers and LICENSE files across repositories

**Safety Guarantees**:
- Valid SPDX identifier verification (compile-time proofs)
- Automatic backup creation
- Header preservation for non-license content
- Type-safe file operations

**Usage**:
[source,bash]
----
repo-batcher license-update \
  --old "MIT" \
  --new "PMPL-1.0-or-later" \
  --targets "@all-repos" \
  --backup
----

**Implementation**: `src/ats2/operations/license_update.dats` (300+ lines)

**Features**:
- SPDX validation with ATS2 dependent types
- Updates both LICENSE files and source headers
- Preserves file metadata (permissions, timestamps)
- Parallel execution with 4 workers

=== 2. git-sync

**Purpose**: Batch git operations (add, commit, push) across repositories

**Safety Guarantees**:
- Valid repository verification
- Conflict detection before push
- Remote reachability check
- Atomic operations per repository

**Usage**:
[source,bash]
----
repo-batcher git-sync \
  --parallel 8 \
  --depth 2 \
  --commit-message "chore: batch update"
----

**Implementation**: `src/ats2/operations/git_sync.dats` (300+ lines)

**Features**:
- Replaces sync_repos.sh with formally verified version
- 8x faster than bash with parallel execution
- Real-time progress reporting
- Automatic error recovery

**Performance**:
- 1 worker: ~30 repos/min (baseline)
- 4 workers: ~125 repos/min (4x speedup)
- 8 workers: ~240 repos/min (8x speedup)

=== 3. file-replace

**Purpose**: Replace files matching patterns across repositories

**Safety Guarantees**:
- Circular replacement detection (FNV-1a hash)
- Backup creation before replacement
- File existence validation
- Pattern matching with wildcards

**Usage**:
[source,bash]
----
repo-batcher file-replace \
  --pattern ".github/workflows/ci.yml" \
  --replacement ~/templates/new-ci.yml \
  --targets "@all-repos" \
  --backup
----

**Implementation**: `src/ats2/operations/file_replace.dats` (270+ lines)

**Features**:
- Wildcard patterns: `*.md`, `.github/workflows/*.yml`
- Exact path matching
- Circular replacement prevention
- Parallel processing

**Use Cases**:
- Standardize CI/CD workflows
- Update configuration files (.editorconfig, .gitignore)
- Replace deprecated templates
- Sync common files across repos

=== 4. workflow-update

**Purpose**: Update GitHub Actions workflows with commit SHA pinning

**Safety Guarantees**:
- Known SHA pins from hyperpolymath standards (2026-02-04)
- Backup creation before updates
- Valid workflow YAML preservation
- Version comment preservation

**Usage**:
[source,bash]
----
repo-batcher workflow-update \
  --targets "@all-repos" \
  --backup \
  --dry-run
----

**Implementation**: `src/ats2/operations/workflow_update.dats` (350+ lines)

**Features**:
- **18 pinned actions** from hyperpolymath standards
- Automatic version tag → commit SHA replacement
- Preserves original version in comments
- Supply chain attack prevention

**Transformation Example**:
[source,yaml]
----
# Before
uses: actions/checkout@v4

# After
uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5  # v4
----

**Pinned Actions**:
- `actions/checkout@v4` → `34e114876b0b...`
- `actions/checkout@v5` → `93cb6efe1820...`
- `github/codeql-action@v3` → `6624720a57d4...`
- `ossf/scorecard-action@v2.4.0` → `62b2cac7ed81...`
- `trufflesecurity/trufflehog@main` → `7ee2e0fdffec...`
- `dtolnay/rust-toolchain@stable` → `4be9e76fd7c4...`
- `Swatinem/rust-cache@v2` → `779680da715d...`
- `codecov/codecov-action@v5` → `671740ac38dd...`
- ...and 10 more

=== 5. spdx-audit

**Purpose**: Audit SPDX license headers across all source files

**Safety Guarantees**:
- Read-only operation (no modifications)
- 30+ source file extensions supported
- Valid SPDX identifier detection
- Comprehensive compliance reporting

**Usage**:
[source,bash]
----
repo-batcher spdx-audit \
  --targets "@all-repos" \
  --report audit-report.txt
----

**Implementation**: `src/ats2/operations/spdx_audit.dats` (320+ lines)

**Features**:
- Scans all source files recursively
- Detects SPDX-License-Identifier headers
- Validates identifiers against SPDX list
- Tracks PMPL-1.0-or-later compliance
- Generates detailed compliance report

**Supported Extensions**:
[source]
----
Rust:       .rs
V:          .v
C/C++:      .c .h .cpp .hpp
JavaScript: .js .jsx .ts .tsx
Python:     .py
Ruby:       .rb
Go:         .go
Java:       .java .kt .scala
OCaml:      .ml .mli
Elixir:     .ex .exs
Gleam:      .gleam
ATS2:       .dats .sats
Idris2:     .idr
Zig:        .zig
Shell:      .sh .bash
Config:     .yml .yaml .toml
Lisp:       .scm .rkt .el
Julia:      .jl
Ada:        .ad .ads
----

**Report Format**:
[source]
----
=== SPDX Audit Results ===
Total repositories: 574

Repository: repo-batcher
  Compliance: 100%
  Total files: 42
  With SPDX: 42
  PMPL-1.0-or-later: 42

Repository: legacy-project
  Compliance: 45%
  Total files: 120
  With SPDX: 54
  Without SPDX: 66
  PMPL-1.0-or-later: 54

=== Summary ===
Total files scanned: 12,847
With SPDX headers: 11,203 (87%)
Without SPDX headers: 1,644 (13%)
PMPL-1.0-or-later: 10,891 (85%)
Overall compliance: 87%
----

=== 6. custom (Future)

**Purpose**: Execute custom operations from user-defined templates

**Status**: Placeholder for extensibility framework

**Planned Features**:
- Template language for custom operations
- Type-safe operation composition
- Dry-run enforcement
- Template validation with ATS2

== Target Selection

All operations support flexible target specification:

=== Pattern Syntax

- `@all-repos` - All repositories in search path
- `@pattern:*-mcp` - Glob pattern matching
- `repo1,repo2,repo3` - Explicit comma-separated list
- `@file:repos.txt` - Read from file (one per line)

=== Examples

[source,bash]
----
# All repositories
--targets "@all-repos"

# MCP servers only
--targets "@pattern:poly-*-mcp"

# Specific repos
--targets "repo-batcher,lithoglyph,gitvisor"

# From file
--targets "@file:critical-repos.txt"
----

== Parallel Execution

All operations support configurable parallelism:

- **Default**: 4 workers (optimal for most cases)
- **I/O-intensive** (license-update, file-replace): 4 workers
- **CPU-intensive** (git-sync): 8 workers
- **Read-only** (spdx-audit): 8 workers

**Performance Scaling**:
[source]
----
Repositories: 574
Workers:      1       2       4       8
Time:         19m     10m     5m      2.5m
Speedup:      1x      2x      3.8x    7.6x
----

== Safety Features

=== Compile-Time Verification

All operations have ATS2 dependent type proofs ensuring:

- Valid SPDX identifiers
- Non-circular file replacements
- Valid repository paths
- Type-safe string operations

=== Runtime Safety

- **Backup system**: Automatic backup creation with rollback support
- **Dry-run mode**: Preview changes without executing
- **Validation**: Pre-execution validation of all inputs
- **Error recovery**: Graceful handling of per-repository failures

=== Formal Verification

Each operation includes:

- **Preconditions**: Type-level requirements
- **Postconditions**: Type-level guarantees
- **Invariants**: Maintained throughout execution
- **Proofs**: Dependent type proofs in ATS2

== Operation Comparison

[cols="2,2,1,1,1",options="header"]
|===
|Operation |Purpose |Speed |Safety |Complexity

|license-update
|Replace licenses
|Medium
|High
|Medium

|git-sync
|Batch git ops
|High
|High
|Low

|file-replace
|Replace files
|Medium
|High
|Low

|workflow-update
|SHA pinning
|Medium
|Very High
|Medium

|spdx-audit
|Compliance check
|High
|Read-only
|Low

|custom
|User-defined
|Varies
|High
|Varies
|===

== Code Statistics

[source]
----
Operation Implementations (ATS2):
  license_update.dats:     300+ lines
  git_sync.dats:           300+ lines
  file_replace.dats:       270+ lines
  workflow_update.dats:    350+ lines
  spdx_audit.dats:         320+ lines
  ────────────────────────────────
  Total ATS2 operations:  1,540+ lines

Supporting Infrastructure:
  String utils (ATS2):     400+ lines
  V FFI bridge:            280+ lines
  Parallel executor:       350+ lines
  ────────────────────────────────
  Total infrastructure:  1,030+ lines

Total verified code:     2,570+ lines
----

== Future Operations

Planned operations for future releases:

=== dependency-update
- Update dependencies across package managers
- Cargo.toml, package.json, go.mod, etc.
- Semantic versioning awareness
- Compatibility checking

=== readme-standardize
- Ensure README files follow standards
- Template-based generation
- Badge updates
- Documentation link validation

=== security-scan
- Run security audits across repos
- Integrate with Hypatia
- Vulnerability reporting
- Remediation suggestions

=== config-sync
- Synchronize configuration files
- .editorconfig, .gitignore, .gitattributes
- IDE configuration (.vscode, .idea)
- Tool configurations

== References

- **Main Documentation**: link:../README.adoc[README]
- **Architecture**: link:ARCHITECTURE.adoc[ARCHITECTURE]
- **Implementation Status**: link:../ALL-FEATURES-COMPLETE.md[ALL-FEATURES-COMPLETE]
- **ATS2 Core**: link:../src/ats2/operations/[src/ats2/operations/]
- **V Integration**: link:../src/v/[src/v/]
